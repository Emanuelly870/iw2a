<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>CRUD Usuários</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body class="container my-4">

    <h1 class="mb-4 text-center">Gerenciar Usuários</h1>

    <!-- Formulário de Cadastro -->
    <div class="mb-4 p-3 border rounded">
        <input type="hidden" id="id_usuario">
        <div class="row g-2">
            <div class="col-md-3">
                <input type="text" id="login" class="form-control" placeholder="Login">
            </div>
            <div class="col-md-3">
                <input type="text" id="email" class="form-control" placeholder="Email">
            </div>
            <div class="col-md-3">
                <input type="text" id="nome" class="form-control" placeholder="Nome">
            </div>
            <div class="col-md-2">
                <input type="password" id="senha" class="form-control" placeholder="Senha">
            </div>
            <div class="col-md-1">
                <select id="ativo" class="form-select">
                    <option value="1">ATIVO</option>
                    <option value="0">INATIVO</option>
                </select>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary me-2" onclick="salvar()">SALVAR</button>
            <button class="btn btn-secondary" onclick="limpar()">CANCELAR</button>
        </div>
    </div>

    <!-- Barra de Pesquisa -->
    <div class="mb-4 p-3 border rounded">
        <div class="row g-2">
            <div class="col-md-6">
                <input type="text" id="pesquisar" class="form-control" placeholder="Pesquisar por Login ou Nome">
            </div>
            <div class="col-md-6 d-flex">
                <button class="btn btn-info me-2" onclick="carregarPesquisa()">Pesquisar</button>
                <button class="btn btn-outline-secondary" onclick="carregar()">Listar Todos</button>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <table class="table table-bordered">
        </table>
        <table id="tabela" class="table table-bordered table-primary">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Login</th>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Ativo</th>
                    <th>Ações</th>
                </tr>
                <table class="table table-bordered">
                    ...
                  </table>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    

    <script>
        const API_URL = "http://localhost:8080/api/usuarios.php";

        function carregar(pesquisa = "") {
            let url = API_URL;
            if (pesquisa) {
                url += "?Pesquisa=" + encodeURIComponent(pesquisa);
            }
            fetch(url)
                .then(resposta => resposta.json())
                .then(dados => {
                    const tbody = document.querySelector("#tabela tbody");
                    tbody.innerHTML = ""; // Limpa a tabela
                    dados.forEach(usuarios => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${usuarios.ID}</td>
                            <td>${usuarios.LOGIN}</td>
                            <td>${usuarios.NOME}</td>
                            <td>${usuarios.EMAIL}</td>
                            <td>${usuarios.ATIVO == 1 ? "Sim" : "Não"}</td>
                            <td>
                                <button class="btn btn-warning btn-sm me-1" onclick='editar(${JSON.stringify(usuarios)})'>Editar</button>
                                <button class="btn btn-danger btn-sm" onclick='excluir(${usuarios.ID})'>Excluir</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        function carregarPesquisa() {
            const valor = document.getElementById("pesquisar").value;
            carregar(valor);
        }

        async function salvar() {
            const id = document.getElementById("id_usuario").value;
            const login = document.getElementById("login").value;
            const nome = document.getElementById("nome").value;
            const email = document.getElementById("email").value;
            const senha = document.getElementById("senha").value;
            const ativo = document.getElementById("ativo").value;

            const payload = { ID: id, LOGIN: login, NOME: nome, EMAIL: email, SENHA: senha, ATIVO: ativo };

            if (id) {
                await fetch(API_URL, { method: "PUT", body: JSON.stringify(payload) });
            } else {
                await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
            }

            limpar();
            carregar();
        }

        function editar(usuarios) {
            document.getElementById("id_usuario").value = usuarios.ID;
            document.getElementById("login").value = usuarios.LOGIN;
            document.getElementById("nome").value = usuarios.NOME;
            document.getElementById("email").value = usuarios.EMAIL;
            document.getElementById("senha").value = usuarios.SENHA;
            document.getElementById("ativo").value = usuarios.ATIVO;
        }

        async function excluir(id) {
            if (confirm("Deseja excluir este usuário?")) {
                await fetch(API_URL + "?id=" + id, { method: "DELETE" });
                carregar();
            }
        }

        function limpar() {
            document.getElementById("id_usuario").value = "";
            document.getElementById("login").value = "";
            document.getElementById("nome").value = "";
            document.getElementById("email").value = "";
            document.getElementById("senha").value = "";
            document.getElementById("ativo").value = "1";
        }

        carregar();
    </script>

</body>

</html>
